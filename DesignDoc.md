# 設計ドキュメント: 資産管理ポートフォリオ管理システム

## 1. はじめに

このドキュメントは、資産管理ポートフォリオ管理システムの現在の要件、仕様、設計をまとめたものであり、特に株式および戦略管理機能に対する最近の機能強化と変更に焦点を当てています。

## 2. 全体アーキテクチャ

本システムはクライアント・サーバーアーキテクチャを採用しています。

*   **フロントエンド**: React、TypeScript、Vite を使用して開発され、ユーザーインターフェースを提供します。
*   **バックエンド**: FastAPI と Python を使用して開発され、API リクエスト、ビジネスロジック、データベース操作を処理します。
*   **データベース**: ポートフォリオデータの永続的な保存には SQLite (SQLAlchemy ORM によって管理) を使用します。

## 3. 主要機能と要件

本システムは以下の主要機能をサポートしています。

*   **銘柄管理**:
    *   ポートフォリオへの新規銘柄の追加。
    *   保有銘柄とその詳細の一覧表示。
    *   既存の銘柄情報 (数量、取得価格、カテゴリ、関連戦略) の更新。
    *   ポートフォリオからの銘柄の削除。
    *   保有銘柄のリアルタイム価格の取得。
*   **戦略管理**:
    *   新規投資戦略の追加。
    *   階層関係を含む、定義されたすべての戦略の一覧表示。
    *   既存の戦略詳細の更新。
    *   戦略の削除。
    *   **階層戦略**: 戦略は親子関係を持つことができます。
    *   **子戦略の1世代制限**: 子戦略はトップレベルの戦略のみを親とすることができます。それ自体が子戦略である戦略を親とすることはできません。
*   **保有銘柄への戦略紐付け**:
    *   銘柄は複数の戦略に関連付けることができます。
    *   **階層選択**: 銘柄に戦略を関連付ける際、ユーザーは「親戦略」と「子戦略」を別々に選択できます。
    *   **直接の子孫制約**: 銘柄に対して子戦略が選択された場合、その直接の親戦略も同じ銘柄に対して選択されている必要があります。銘柄は複数の親戦略と子戦略に関連付けることができ、親戦略のみ、または子戦略のみを選択することも可能です（直接の子孫ルールが満たされている場合）。
*   **資産配分**:
    *   カテゴリごとの現在の資産構成の表示。
    *   目標資産配分比率の設定。

## 4. 設計詳細 (バックエンド)

### 4.1. モデル (`backend/models.py`)

*   **`Stock`**: 保有銘柄を表します。
    *   属性: `id`、`ticker`、`name`、`quantity`、`acquisition_price`、`category`。
    *   **関係**: `stock_strategy_association` テーブルを介した `Strategy` との多対多の関係。
*   **`Strategy`**: 投資戦略を表します。
    *   属性: `id`、`name`、`description`。
    *   **関係**: 親子階層のための自己参照関係 (`parent_id`、`parent`、`children`)。
    *   **関係**: `stock_strategy_association` テーブルを介した `Stock` との多対多の関係。
*   **`TargetAllocation`**: カテゴリごとの目標配分比率を表します。

### 4.2. スキーマ (`backend/schemas.py`)

データ検証とシリアライズのための Pydantic モデル。

*   **`StockBase`**: 銘柄データの基本スキーマ。`strategy_ids: Optional[List[int]]` を含みます。
*   **`StockCreate`**: `StockBase` を継承します。
*   **`StockUpdate`**: `StockBase` を継承します。
*   **`Stock`**: 銘柄データのレスポンスモデル。`strategies: List[Strategy]` (Eager Loading) を含みます。
*   **`StrategyBase`**: 戦略データの基本スキーマ。`parent_id: Optional[int]` を含みます。
*   **`StrategyCreate`**: `StrategyBase` を継承します。
*   **`Strategy`**: 戦略データのレスポンスモデル。`id` を含みます。

### 4.3. CRUD 操作 (`backend/crud.py`)

*   **`get_strategies(db, skip, limit, parent_id)`**:
    *   **変更**: `parent_id` が `None` の場合、トップレベルの戦略だけでなく、*すべての*戦略を返すようになりました。これにより、フロントエンドで完全な階層を構築できます。
*   **`create_strategy(db, strategy)`**:
    *   **検証追加**: 「子戦略の1世代制限」を実装します。`parent_id` が指定されている場合、親戦略自体が `parent_id` を持っているかどうかをチェックします。持っている場合、`HTTPException` (400 Bad Request) を発生させます。
*   **`create_stock(db, stock_data)`**:
    *   `stock_data` からの `strategy_ids` と `Stock` オブジェクトの関連付けを処理します。
*   **`update_stock(db, stock_id, stock)`**:
    *   既存の `Stock` オブジェクトの `strategy_ids` 関連付けの更新を処理します（既存のものをクリアし、新しいものを追加します）。
*   **`get_stock(db, stock_id)` / `get_stocks(db, skip, limit)`**: そのまま
    *   **変更**: `joinedload` を使用して `strategies` 関係を Eager Loading するように変更され、関連する戦略が銘柄データと共に取得されるようにすることで、フロントエンドでの N+1 クエリの問題を軽減します。

### 4.4. API エンドポイント (`backend/main.py`)

*   **`validate_strategy_hierarchy(db, strategy_ids)` (ヘルパー関数)**:
    *   **追加**: この関数は、銘柄に戦略を紐付ける際の「直接の子孫制約」に対するサーバーサイド検証を実行します。提供された `strategy_ids` を反復処理し、選択された戦略が子戦略である場合、その直接の親が `strategy_ids` リストにも存在することを確認します。存在しない場合、`HTTPException` (400 Bad Request) を発生させます。
*   **`POST /stocks/` (create_stock エンドポイント)**:
    *   **検証追加**: 銘柄を作成する前に `validate_strategy_hierarchy` を呼び出し、直接の子孫制約を強制します。
*   **`PUT /stocks/{stock_id}` (update_stock エンドポイント)**:
    *   **検証追加**: 銘柄を更新する前に `validate_strategy_hierarchy` を呼び出し、直接の子孫制約を強制します。
*   **`GET /strategies/`**: 変更された `crud.get_strategies` の動作に基づいて戦略を返します。

## 5. 設計詳細 (フロントエンド)

### 5.1. `frontend/src/components/StockFormPage.tsx` (銘柄追加ページ)

*   **変更**: すべての戦略選択フィールドと関連ロジックを削除しました。このページは、基本的な銘柄情報の追加のみを目的としています。

### 5.2. `frontend/src/components/StockListPage.tsx` (保有銘柄一覧ページ)

*   **編集モードでの戦略選択**:
    *   **実装**: 銘柄を編集する際、戦略選択は2つの独立した複数選択ドロップダウンを使用するようになりました。「親戦略」用と「子戦略」用です。
    *   **動的な子オプション**: 「子戦略」ドロップダウンで利用可能なオプションは、「親戦略」ドロップダウンで選択された戦略の直接の子のみを表示するように動的にフィルタリングされます。
    *   **フロントエンド検証**: 子戦略が選択されている場合、その親戦略も「親戦略」ドロップダウンで選択されていることを確認するクライアントサイド検証を実装します。このルールに違反した場合、アラートが表示されます。
    *   **表示**: 関連付けられた戦略は、銘柄一覧テーブルに表示されます（例: `stock.strategies.map(s => s.name).join(', ')`）。
    *   **ユーザーガイダンス**: 子戦略の選択方法をユーザーに案内するメッセージを追加しました（例: 「親戦略を選択すると、関連する子戦略が表示されます。」）。

### 5.3. `frontend/src/components/StrategyPage.tsx` (戦略管理ページ)

*   **エラー処理の改善**: 戦略作成時にバックエンドからの詳細なエラーメッセージ（例: 「Strategy with this name already registered」）を表示するように変更され、ユーザーにより明確なフィードバックを提供します。

### 5.4. `frontend/src/App.tsx`

*   **`Stock` インターフェースの更新**: `Stock` インターフェースに `strategies: Strategy[]` が含まれるようになり、バックエンドから受け取った Eager Loading された戦略データを正しく型付けし、子コンポーネントに渡せるようになりました。
*   **`Strategy` インターフェースの定義**: フロントエンド全体での一貫性のために、`Strategy` インターフェースの定義を追加しました。

## サーバーの起動

便宜上、プロジェクトのルートに `start_servers.bat` というバッチスクリプトが用意されており、バックエンド (FastAPI) とフロントエンド (React) の両方の開発サーバーを同時に起動できます。

使用方法:
1.  すべての依存関係をインストールするために、「バックエンドのセットアップ」と「フロントエンドのセットアップ」の手順を少なくとも一度は完了していることを確認してください。
2.  プロジェクトのルートディレクトリ (`C:\Users\y-murase\Documents\Dev\ShisanKanri`) から、`start_servers.bat` をダブルクリックするか、コマンドラインから実行します。
    ```bash
    start_servers.bat
    ```
3.  バックエンドサーバー用とフロントエンドサーバー用の2つの新しいコマンドプロンプトウィンドウが開きます。
4.  サーバーを停止するには、これらのコマンドプロンプトウィンドウを閉じるか、利用可能な場合は `stop_servers.bat` スクリプトを使用します。

## Database
-   The SQLite database file `portfolio.db` is located in the project root.
-   Database migrations are handled automatically by SQLAlchemy (for initial setup).

## API エンドポイント (例)
-   `/stocks/`: GET (すべての銘柄を一覧表示)、POST (新しい銘柄を追加)
-   `/stocks/{stock_id}`: GET (単一の銘柄を取得)、PUT (銘柄を更新)、DELETE (銘柄を削除)
-   `/market_data/refresh`: POST (市場データを更新)

## 6. 今後の検討事項 / 既知の問題

*   **エラー処理の一貫性**: 戦略作成や銘柄と戦略の紐付けにおいて特定の詳細なエラーメッセージが表示されるようになりましたが、アプリケーション全体でより一元化された、ユーザーフレンドリーなエラー表示メカニズムを実装することができます。
*   **UI/UX の改善**: 戦略の複数選択ドロップダウンは、多数の戦略がある場合の使いやすさを向上させるために、検索機能やより高度な UI コンポーネントで強化することができます。
*   **テスト**: フロントエンドとバックエンドの機能に対する包括的な単体テストと統合テストは、堅牢性を確保し、回帰を防ぐために重要です。

*   **機能追加**: 各保有銘柄の個別ページを実装し、以下の機能を提供する:
    *   **株式指標の表示**: 株価、前日比、PER、PBR、配当利回り、時価総額、出来高、52週高値/安値、移動平均線。
    *   **指標説明ダイアログ**: 各指標をクリックすると、その説明をダイアログで表示。
    *   **関連ニュース一覧**: 直近の関連ニュースへのリンク一覧を表示。
*   **通貨表記**: アプリケーションのUIにおけるすべての金額表示（例: 合計評価損益、取得価格、配当利回りなど）は、ドル ($) 表記とする。
*   **LLM組み込み**: 各保有銘柄の個別ページにLLMを組み込み、対象銘柄についてユーザーが相談できるようにする。
*   **LLM組み込み (投資戦略)**: 投資戦略についてユーザーがLLMに相談できるようにする。
